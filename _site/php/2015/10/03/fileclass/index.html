<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      PHP文件上传类(支持单文件上传，也支持多文件上传) &middot; 可了头i的博客
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/naringu.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/form.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="shortcut icon" href="./public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  <link rel="alternate" type="application/rss+xml" title="Mozilla RSS" href="feed.category.xml">
  </head>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48740529-1', 'auto');
  ga('send', 'pageview');

</script>


<body class="theme-6dd">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
      <img width="125" height="125" alt="A photo of ariestiyansyah" src="/images/head.jpeg">
    <p>oonlab is crafted with <3 by ariestiyansyah.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
    
      
        
          <a class="sidebar-nav-item" href="/categories/">Category Index</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/contact/">Contact</a>
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <a class="sidebar-nav-item" href="http://github.com">GitHub project</a>
    <span class="sidebar-nav-item">Version 2.0</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2016. All rights reserved.
    </p>
  </div>
</div>


    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">可了头i的博客</a>
            <small>A GOOD MAN</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">PHP文件上传类(支持单文件上传，也支持多文件上传)</h1>
  <span class="post-date">03 Oct 2015</span>
  <hr />
<!-- more -->

<p>```
&lt;?php<br />
  /**
    file: fileupload.class.php 文件上传类FileUpload 
    本类的实例对象用于处理上传文件，可以上传一个文件，也可同时处理多个文件上传 
  */<br />
  class FileUpload { <br />
    private $path = “./uploads”;          //上传文件保存的路径<br />
    private $allowtype = array(‘jpg’,’gif’,’png’); //设置限制上传文件的类型<br />
    private $maxsize = 1000000;           //限制文件上传大小（字节）<br />
    private $israndname = true;           //设置是否随机重命名文件， false不随机</p>

<pre><code>private $originName;              //源文件名  
private $tmpFileName;              //临时文件名  
private $fileType;               //文件类型(文件后缀)  
private $fileSize;               //文件大小  
private $newFileName;              //新文件名  
private $errorNum = 0;             //错误号  
private $errorMess="";             //错误报告消息  
   
/** 
 * 用于设置成员属性（$path, $allowtype,$maxsize, $israndname） 
 * 可以通过连贯操作一次设置多个属性值 
 *@param  string $key  成员属性名(不区分大小写) 
 *@param  mixed  $val  为成员属性设置的值 
 *@return  object     返回自己对象$this，可以用于连贯操作 
 */  
function set($key, $val){  
  $key = strtolower($key);   
  if( array_key_exists( $key, get_class_vars(get_class($this) ) ) ){  
    $this-&gt;setOption($key, $val);  
  }  
  return $this;  
}  
   
/** 
 * 调用该方法上传文件 
 * @param  string $fileFile  上传文件的表单名称  
 * @return bool        如果上传成功返回数true  
 */  
   
function upload($fileField) {  
  $return = true;  
  /* 检查文件路径是滞合法 */  
  if( !$this-&gt;checkFilePath() ) {         
    $this-&gt;errorMess = $this-&gt;getError();  
    return false;  
  }  
  /* 将文件上传的信息取出赋给变量 */  
  $name = $_FILES[$fileField]['name'];  
  $tmp_name = $_FILES[$fileField]['tmp_name'];  
  $size = $_FILES[$fileField]['size'];  
  $error = $_FILES[$fileField]['error'];  
   
  /* 如果是多个文件上传则$file["name"]会是一个数组 */  
  if(is_Array($name)){      
    $errors=array();  
    /*多个文件上传则循环处理 ， 这个循环只有检查上传文件的作用，并没有真正上传 */  
    for($i = 0; $i &lt; count($name); $i++){   
      /*设置文件信息 */  
      if($this-&gt;setFiles($name[$i],$tmp_name[$i],$size[$i],$error[$i] )) {  
        if(!$this-&gt;checkFileSize() || !$this-&gt;checkFileType()){  
          $errors[] = $this-&gt;getError();  
          $return=false;   
        }  
      }else{  
        $errors[] = $this-&gt;getError();  
        $return=false;  
      }  
      /* 如果有问题，则重新初使化属性 */  
      if(!$return)            
        $this-&gt;setFiles();  
    }  
   
    if($return){  
      /* 存放所有上传后文件名的变量数组 */  
      $fileNames = array();        
      /* 如果上传的多个文件都是合法的，则通过销魂循环向服务器上传文件 */  
      for($i = 0; $i &lt; count($name); $i++){   
        if($this-&gt;setFiles($name[$i], $tmp_name[$i], $size[$i], $error[$i] )) {  
          $this-&gt;setNewFileName();   
          if(!$this-&gt;copyFile()){  
            $errors[] = $this-&gt;getError();  
            $return = false;  
          }  
          $fileNames[] = $this-&gt;newFileName;    
        }            
      }  
      $this-&gt;newFileName = $fileNames;  
    }  
    $this-&gt;errorMess = $errors;  
    return $return;  
  /*上传单个文件处理方法*/  
  } else {  
    /* 设置文件信息 */  
    if($this-&gt;setFiles($name,$tmp_name,$size,$error)) {  
      /* 上传之前先检查一下大小和类型 */  
      if($this-&gt;checkFileSize() &amp;&amp; $this-&gt;checkFileType()){   
        /* 为上传文件设置新文件名 */  
        $this-&gt;setNewFileName();   
        /* 上传文件  返回0为成功， 小于0都为错误 */  
        if($this-&gt;copyFile()){   
          return true;  
        }else{  
          $return=false;  
        }  
      }else{  
        $return=false;  
      }  
    } else {  
      $return=false;   
    }  
    //如果$return为false, 则出错，将错误信息保存在属性errorMess中  
    if(!$return)  
      $this-&gt;errorMess=$this-&gt;getError();    
   
    return $return;  
  }  
}  
   
/**  
 * 获取上传后的文件名称 
 * @param  void   没有参数 
 * @return string 上传后，新文件的名称， 如果是多文件上传返回数组 
 */  
public function getFileName(){  
  return $this-&gt;newFileName;  
}  
   
/** 
 * 上传失败后，调用该方法则返回，上传出错信息 
 * @param  void   没有参数 
 * @return string  返回上传文件出错的信息报告，如果是多文件上传返回数组 
 */  
public function getErrorMsg(){  
  return $this-&gt;errorMess;  
}  
   
/* 设置上传出错信息 */  
private function getError() {  
  $str = "上传文件&lt;font color='red'&gt;{$this-&gt;originName}&lt;/font&gt;时出错 : ";  
  switch ($this-&gt;errorNum) {  
    case 4: $str .= "没有文件被上传"; break;  
    case 3: $str .= "文件只有部分被上传"; break;  
    case 2: $str .= "上传文件的大小超过了HTML表单中MAX_FILE_SIZE选项指定的值"; break;  
    case 1: $str .= "上传的文件超过了php.ini中upload_max_filesize选项限制的值"; break;  
    case -1: $str .= "未允许类型"; break;  
    case -2: $str .= "文件过大,上传的文件不能超过{$this-&gt;maxsize}个字节"; break;  
    case -3: $str .= "上传失败"; break;  
    case -4: $str .= "建立存放上传文件目录失败，请重新指定上传目录"; break;  
    case -5: $str .= "必须指定上传文件的路径"; break;  
    default: $str .= "未知错误";  
  }  
  return $str.'&lt;br&gt;';  
}  
   
/* 设置和$_FILES有关的内容 */  
private function setFiles($name="", $tmp_name="", $size=0, $error=0) {  
  $this-&gt;setOption('errorNum', $error);  
  if($error)  
    return false;  
  $this-&gt;setOption('originName', $name);  
  $this-&gt;setOption('tmpFileName',$tmp_name);  
  $aryStr = explode(".", $name);  
  $this-&gt;setOption('fileType', strtolower($aryStr[count($aryStr)-1]));  
  $this-&gt;setOption('fileSize', $size);  
  return true;  
}  
   
/* 为单个成员属性设置值 */  
private function setOption($key, $val) {  
  $this-&gt;$key = $val;  
}  
   
/* 设置上传后的文件名称 */  
private function setNewFileName() {  
  if ($this-&gt;israndname) {  
    $this-&gt;setOption('newFileName', $this-&gt;proRandName());    
  } else{   
    $this-&gt;setOption('newFileName', $this-&gt;originName);  
  }   
}  
   
/* 检查上传的文件是否是合法的类型 */  
private function checkFileType() {  
  if (in_array(strtolower($this-&gt;fileType), $this-&gt;allowtype)) {  
    return true;  
  }else {  
    $this-&gt;setOption('errorNum', -1);  
    return false;  
  }  
}  
   
/* 检查上传的文件是否是允许的大小 */  
private function checkFileSize() {  
  if ($this-&gt;fileSize &gt; $this-&gt;maxsize) {  
    $this-&gt;setOption('errorNum', -2);  
    return false;  
  }else{  
    return true;  
  }  
}  
   
/* 检查是否有存放上传文件的目录 */  
private function checkFilePath() {  
  if(empty($this-&gt;path)){  
    $this-&gt;setOption('errorNum', -5);  
    return false;  
  }  
  if (!file_exists($this-&gt;path) || !is_writable($this-&gt;path)) {  
    if (!@mkdir($this-&gt;path, 0755)) {  
      $this-&gt;setOption('errorNum', -4);  
      return false;  
    }  
  }  
  return true;  
}  
   
/* 设置随机文件名 */  
private function proRandName() {      
  $fileName = date('YmdHis')."_".rand(100,999);      
  return $fileName.'.'.$this-&gt;fileType;   
}  
   
/* 复制上传文件到指定的位置 */  
private function copyFile() {  
  if(!$this-&gt;errorNum) {  
    $path = rtrim($this-&gt;path, '/').'/';  
    $path .= $this-&gt;newFileName;  
    if (@move_uploaded_file($this-&gt;tmpFileName, $path)) {  
      return true;  
    }else{  
      $this-&gt;setOption('errorNum', -3);  
      return false;  
    }  
  } else {  
    return false;  
  }  
}     }   ``` **文件上传类的应用过程：**
</code></pre>

<p>本列的文件上传类FileUpload，不仅支持单文件上传，也支持多文件上传。
  在处理方式上没有区别，只不过在编写上传表单时，多个文件上传一定要以数组方式传递给服务器。
  单个文件上传表单如下所示：</p>

<p><img src="/res/img/blog/PHP学习/fileClass_1.jpg" alt="fileClass_1" /></p>

<p>上面表单都是，都将提交的位置指向了同一个文件upload.php，
  所以不难看出单个和多个文件上传是一样的处理方式，upload.php代码如下所示：
```
      &lt;?php<br />
      //包含一个文件上传类中的上传类<br />
      include “fileupload.class.php”;</p>

<pre><code>  $up = new fileupload;  
  //设置属性(上传的位置， 大小， 类型， 名是是否要随机生成)  
  $up -&gt; set("path", "./images/");  
  $up -&gt; set("maxsize", 2000000);  
  $up -&gt; set("allowtype", array("gif", "png", "jpg","jpeg"));  
  $up -&gt; set("israndname", false);  
 
  //使用对象中的upload方法， 就可以上传文件， 方法需要传一个上传表单的名子 pic, 如果成功返回true, 失败返回false  
  if($up -&gt; upload("pic")) {  
      echo '&lt;pre&gt;';  
      //获取上传后文件名子  
      var_dump($up-&gt;getFileName());  
      echo '&lt;/pre&gt;';  
 
  } else {  
      echo '&lt;pre&gt;';  
      //获取上传失败以后的错误提示  
      var_dump($up-&gt;getErrorMsg());  
      echo '&lt;/pre&gt;';  
  }     ?&gt;&lt;span id="transmark" style="display: none; width: 0px; height: 0px;"&gt;&lt;/span&gt;   ```
</code></pre>


</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/mvc/2016/09/01/mvc-talk-lightly/">
            浅谈MVC架构模式分析与设计
            <small>01 Sep 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/php/2016/08/05/php-thing/">
            PHP事物处理
            <small>05 Aug 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/php/2016/08/03/magic-methods/">
            PHP魔术方法
            <small>03 Aug 2016</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div class="comments">
    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'testnaringu';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'testnaringu';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>

    <div align="center" class="footer">
        <a href="https://github.com/ariestiyansyah/naringu" target="_blank" title="naringu">Naringu</a>  is designed by Rizky Ariestiyansyah<br />Copyright © 2016 <br>
    </div>
  </body>
</html>

