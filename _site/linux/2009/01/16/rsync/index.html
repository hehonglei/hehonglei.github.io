<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
       inotify+rsync安装配置,文件同步  &middot; 可了头i的博客
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/naringu.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/form.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="shortcut icon" href="./public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  <link rel="alternate" type="application/rss+xml" title="Mozilla RSS" href="feed.category.xml">
  </head>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48740529-1', 'auto');
  ga('send', 'pageview');

</script>


<body class="theme-6dd">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
      <img width="125" height="125" alt="A photo of ariestiyansyah" src="/images/head.jpeg">
    <p>oonlab is crafted with <3 by ariestiyansyah.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
    
      
        
          <a class="sidebar-nav-item" href="/categories/">Category Index</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/contact/">Contact</a>
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <a class="sidebar-nav-item" href="http://github.com">GitHub project</a>
    <span class="sidebar-nav-item">Version 2.0</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2016. All rights reserved.
    </p>
  </div>
</div>


    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">可了头i的博客</a>
            <small>A GOOD MAN</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title"> inotify+rsync安装配置,文件同步 </h1>
  <span class="post-date">16 Jan 2009</span>
  <p>1.两台机器192.168.1.2，192.168.1.3，想把192.168.1.2的数据同步到192.168.1.3中</p>

<p>2.测试开始，可以先关闭防火墙和内核Linux的selinux的防火墙,避免防火墙影响（两台服务器均操作）</p>

<p>关闭防火墙，例如centos7，其他系统版本自己查询如何关闭</p>

<p>[python] view plain copy
在CODE上查看代码片派生到我的代码片</p>

<pre><code>$ systemctl stop firewalld.service #停止firewall  
$ systemctl disable firewalld.service #禁止firewall开机启动  
</code></pre>

<p>关闭linux的selinux防火墙</p>

<p>永久性关闭：生效需要重启</p>

<p>[plain] view plain copy
在CODE上查看代码片派生到我的代码片</p>

<pre><code>$ vi /etc/selinux/config  
SELINUX=disabled  
</code></pre>

<p>临时性关闭：生效无需重启</p>

<p>[plain] view plain copy
在CODE上查看代码片派生到我的代码片</p>

<pre><code>$ setenforce 0  
</code></pre>

<p>3.安装rsync（两台服务器均操作）</p>

<p>前往rsync官网下载最新版本 http://rsync.samba.org/ftp/rsync/src  找到最新的rsync-<em>.</em>.*.tar.gz</p>

<p>[plain] view plain copy
在CODE上查看代码片派生到我的代码片</p>

<pre><code>$ tar zxvf rsync-*.*.*.tar.gz  
$ cd rsync-*.*.*  
$ ./configure --prefix=/usr/local/rsync  
$ make &amp;&amp; make install  
</code></pre>

<p>4.配置rsyncd.conf (192.168.1.3)
[plain] view plain copy
在CODE上查看代码片派生到我的代码片</p>

<pre><code>#pid文件的存放位置  
pid file = /var/run/rsync.pid  
#日志文件位置，启动rsync后自动产生这个文件，无需提前创建  
log file = /var/log/rsync.log  
#支持max connections参数的锁文件  
lock file=/var/run/rsync.lock  
#用户认证配置文件，里面保存用户名称和密码  
secrets file = /etc/rsync.pw  
#rsync启动时欢迎信息页面文件位置  
motd file = /etc/rsyncd.motd  
transfer logging = yes  
log format = %t %a %m %f %b  
syslog facility = local3  
#自定义名称  
[data]  
#设置需要同步的目录  
path = /data/test/  
#模块名称与[data]自定义名称相同  
comment = data  
exclude = blank.png ; spinner.gif ; downsimple.png ; rails.png ; WEB-INF/  
#默认端口  
port = 873  
#设置rsync运行权限为root  
uid = root  
#设置rsync运行权限为root  
gid = root  
#设置超时时间  
timeout = 600  
#最大连接数  
max connections = 200  
#默认为true，修改为no，增加对目录文件软连接的备份  
use chroot = no  
#设置rsync服务端文件为读写权限  
read only = no  
#不显示rsync服务端资源列表  
list = no  
#允许进行数据同步的客户端IP地址  
hosts allow = 192.168.1.2  
</code></pre>

<p>4.可选：可以设置多个目录(192.168.1.3)
[plain] view plain copy
在CODE上查看代码片派生到我的代码片</p>

<pre><code>#增加test1目录  
[test1]  
path = /data/test1  
list = yes  
ignore errors  
comment = ucweb-file system  
secrets file = /etc/rsync.pw  
exclude = blank.png ; spinner.gif ; downsimple.png ; rails.png ; WEB-INF/  
</code></pre>

<p>5.建立密码认证文件(192.168.1.3)</p>

<p>[plain] view plain copy
在CODE上查看代码片派生到我的代码片</p>

<pre><code>$ vi /etc/rsync.pw  
root:123456  
</code></pre>

<p>配置rsyncd.motd文件，开始传送的时候会显示（192.168.1.3）</p>

<p>[plain] view plain copy
在CODE上查看代码片派生到我的代码片</p>

<pre><code>$ vi /etc/rsyncd.motd  
###############################  
#                             #  
#        start rsync          #  
#                             #  
###############################  
</code></pre>

<p>5.启动rsync（两台服务器均操作）</p>

<p>[plain] view plain copy
在CODE上查看代码片派生到我的代码片</p>

<pre><code>$ /usr/local/rsync/bin/rsync --daemon --config=/etc/rsyncd.conf  
</code></pre>

<p>开机启动rsync</p>

<p>[plain] view plain copy
在CODE上查看代码片派生到我的代码片</p>

<pre><code>$ echo '/usr/local/rsync/bin/rsync --daemon --config=/etc/rsyncd.conf'&gt;&gt;/etc/rc.d/rc.local  
</code></pre>

<p>6.建立密码认证文件（192.168.1.2）
[plain] view plain copy
在CODE上查看代码片派生到我的代码片</p>

<pre><code>$ vi /etc/rsync.pw  
123456  
</code></pre>

<p>7.测试开始（在192.168.1.2）</p>

<p>先打开192.168.1.2上的/data/test/创建一个test.PHP测试文件，执行下面的命令</p>

<p>[plain] view plain copy
在CODE上查看代码片派生到我的代码片</p>

<pre><code>$ /usr/local/rsync/bin/rsync -avH --port=873 --progress --delete /data/test/ root@192.168.1.3::data --password-file=/etc/rsync.pw  
</code></pre>

<p>查看192.168.1.3上/data/test目录下是否有同步过来的test.php</p>

<p>8.安装inotify-tools（192.168.1.2）
[plain] view plain copy
在CODE上查看代码片派生到我的代码片</p>

<pre><code>$ wget https://cloud.github.com/downloads/rvoicilas/inotify-tools/inotify-tools-3.14.tar.gz  
$ tar zxvf inotify-tools-3.14.tar.gz   
$ cd inotify-tools-3.14  
$ ./configure --prefix=/usr/local/inotify  
$ make &amp;&amp; make install  
</code></pre>

<p>9.查看是否安装成功</p>

<p>[plain] view plain copy
在CODE上查看代码片派生到我的代码片</p>

<pre><code>$ ll /usr/local/inotify/bin/inotifywa*  
</code></pre>

<p>10.新建一个inotify.sh设置文件同步/root/inotify.sh,如果下面代码不管用可参考https://github.com/rvoicilas/inotify-tools/wiki#info</p>

<p>#!/bin/sh</p>

<h1 id="get-the-current-path">get the current path</h1>
<p>CURPATH=<code>pwd</code></p>

<p>/usr/local/inotify/bin/inotifywait -mr –timefmt ‘%d/%m/%y %H:%M’ –format ‘%T %w %f’ \
-e close_write /data/test | while read date time dir file; do</p>

<pre><code>   FILECHANGE=${dir}${file}
   # convert absolute path to relative
   FILECHANGEREL=`echo "$FILECHANGE" | sed 's_'$CURPATH'/__'`


   rsync -avH --port=873 --progress --delete /data/test/ root@192.168.1.3::data --password-file=/etc/rsync.pw
    echo "At ${time} on ${date}, file $FILECHANGE was backed up via rsync" done
</code></pre>

<p>11.可执行权限与后台无输出运行
chmod 777 /root/inotify.sh</p>

<p>[php] view plain copy
在CODE上查看代码片派生到我的代码片</p>

<pre><code>sh /root/inotify.sh &gt;/dev/null 2&gt;&amp;1 &amp;  
</code></pre>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/mvc/2016/09/01/mvc-talk-lightly/">
            浅谈MVC架构模式分析与设计
            <small>01 Sep 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/php/2016/08/05/php-thing/">
            PHP事物处理
            <small>05 Aug 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/php/2016/08/03/magic-methods/">
            PHP魔术方法
            <small>03 Aug 2016</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div class="comments">
    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'testnaringu';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'testnaringu';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>

    <div align="center" class="footer">
        <a href="https://github.com/ariestiyansyah/naringu" target="_blank" title="naringu">Naringu</a>  is designed by Rizky Ariestiyansyah<br />Copyright © 2016 <br>
    </div>
  </body>
</html>

